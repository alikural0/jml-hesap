<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>JML Dƒ±≈ü Ticaret</title>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="theme-color" content="#0b0b0c">
  <link rel="apple-touch-icon" href="./icon-192.png">

  <style>
    :root{
      --bg:#0b0b0c;
      --stroke:rgba(255,255,255,.10);
      --stroke2:rgba(255,255,255,.16);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.62);
      --muted2:rgba(255,255,255,.45);
      --shadow:0 18px 55px rgba(0,0,0,.55);
      --r:18px;

      --key:rgba(255,255,255,.06);
      --keyHover:rgba(255,255,255,.09);
      --good:rgba(255,255,255,.14);
    }

    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh;
      background:
        radial-gradient(900px 600px at 20% 15%, rgba(255,255,255,.06), transparent 60%),
        radial-gradient(900px 600px at 80% 85%, rgba(255,255,255,.05), transparent 60%),
        linear-gradient(180deg, var(--bg), #070708);
      color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      display:flex; justify-content:center;
      padding:22px 12px;
    }

    .wrap{width:min(560px,100%); display:flex; flex-direction:column; gap:12px}

    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:14px;
      border-radius:var(--r);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.04));
      border:1px solid var(--stroke);
      box-shadow:var(--shadow);
      backdrop-filter: blur(12px);
    }
    .brand{display:flex; align-items:center; gap:12px; min-width:0}
    .brand img{
      height:40px; width:auto;
      background:#fff;
      border-radius:12px;
      padding:6px 8px;
      border:1px solid rgba(0,0,0,.08);
      box-shadow:0 10px 28px rgba(0,0,0,.35);
      flex:0 0 auto;
    }
    .brand .text{display:flex; flex-direction:column; min-width:0}
    .brand b{
      font-size:14px; letter-spacing:.9px; font-weight:800;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .brand span{
      margin-top:3px;
      font-size:11px; letter-spacing:1.1px; text-transform:uppercase;
      color:var(--muted2);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }

    .right{display:flex; align-items:center; gap:10px}
    .chip{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.05);
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
      user-select:none;
    }
    .sel{
      height:34px; border-radius:999px;
      background:rgba(255,255,255,.05);
      border:1px solid var(--stroke);
      color:var(--text);
      padding:0 10px;
      outline:none;
      cursor:pointer;
      font-size:12px;
    }

    .card{
      border-radius:var(--r);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--stroke);
      box-shadow:var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(12px);
    }

    .tabs{
      display:flex;
      gap:8px;
      padding:10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }
    .tab{
      flex:0 0 auto;
      padding:0 14px;
      height:40px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.04);
      color:var(--muted);
      cursor:pointer;
      font-size:13px;
      transition:.12s transform,.12s background,.12s color,.12s border-color;
      white-space:nowrap;
    }
    .tab:hover{transform:translateY(-1px); background:rgba(255,255,255,.06); color:var(--text); border-color:rgba(255,255,255,.14)}
    .tab.active{background:rgba(255,255,255,.10); color:var(--text); border-color:rgba(255,255,255,.18)}

    .panel{display:none; padding:14px}
    .panel.active{display:block}

    .screen{
      width:100%; height:76px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.32);
      color:var(--text);
      padding:12px 14px;
      text-align:right;
      font-size:30px;
      outline:none;
    }
    .subline{
      margin-top:8px;
      display:flex; justify-content:space-between;
      flex-wrap:wrap; gap:10px;
      font-size:12px;
      color:var(--muted2);
    }

    .grid{
      margin-top:12px;
      display:grid;
      grid-template-columns:repeat(4,1fr);
      gap:10px;
      touch-action:manipulation;
      user-select:none;
    }
    button.key{
      height:56px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background:var(--key);
      color:var(--text);
      font-size:18px;
      cursor:pointer;
      transition:.10s transform,.10s background,.10s border-color;
    }
    button.key:hover{transform:translateY(-1px); background:var(--keyHover); border-color:rgba(255,255,255,.16)}
    button.key:active{transform:translateY(0) scale(.99)}
    .op{background:rgba(255,255,255,.07); border-color:rgba(255,255,255,.14)}
    .danger{background:rgba(255,255,255,.08); border-color:rgba(255,255,255,.14)}
    .good{background:var(--good); border-color:rgba(255,255,255,.20)}
    .wide{grid-column:span 2}
    .eq{grid-column:span 2}

    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .field{
      flex:1; min-width:150px;
      height:44px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.26);
      color:var(--text);
      padding:0 12px;
      outline:none;
    }
    .btn{
      height:44px;
      padding:0 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.05);
      color:var(--text);
      cursor:pointer;
      transition:.10s transform,.10s background;
      font-size:13px;
      white-space:nowrap;
    }
    .btn:hover{transform:translateY(-1px); background:rgba(255,255,255,.07)}
    .btn:active{transform:translateY(0) scale(.99)}

    .out{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.24);
      font-size:13px;
      color:rgba(255,255,255,.86);
      line-height:1.45;
      word-break:break-word;
    }
    .out b{color:var(--text)}
    .hint{margin-top:10px; font-size:12px; color:var(--muted2); line-height:1.45}

    .listItem{
      border-bottom:1px solid rgba(255,255,255,.08);
      padding:10px 0;
    }
    .listItem:last-child{border-bottom:none}

    @media (max-width:420px){
      .brand img{height:36px}
      .chip{display:none}
      .screen{font-size:26px; height:72px}
      button.key{height:54px}
    }
  </style>
</head>

<body>
<div class="wrap">

  <div class="topbar">
    <div class="brand">
      <img src="logo.png" alt="JML Dƒ±≈ü Ticaret">
      <div class="text">
        <b>JML DI≈û Tƒ∞CARET</b>
        <span>HESAP ‚Ä¢ KDV ‚Ä¢ Y√úZDE ‚Ä¢ KAR/ZARAR ‚Ä¢ KUR ‚Ä¢ ƒ∞HRACAT ‚Ä¢ YORUMLAR</span>
      </div>
    </div>

    <div class="right">
      <select id="currency" class="sel" title="G√∂sterim para birimi">
        <option value="TRY" selected>‚Ç∫ TL</option>
        <option value="USD">$ USD</option>
      </select>
      <div class="chip">Mobil: Dokun ‚Ä¢ Enter: =</div>
    </div>
  </div>

  <div class="card">
    <div class="tabs" id="tabs">
      <button class="tab active" data-tab="calc" type="button">Hesap</button>
      <button class="tab" data-tab="kdv" type="button">KDV</button>
      <button class="tab" data-tab="pct" type="button">Y√ºzde</button>
      <button class="tab" data-tab="profit" type="button">Kar/Zarar</button>
      <button class="tab" data-tab="fx" type="button">Kur</button>
      <button class="tab" data-tab="export" type="button">ƒ∞hracat</button>
      <button class="tab" data-tab="comments" type="button">Yorumlar</button>
    </div>

    <!-- HESAP -->
    <div class="panel active" id="panel-calc">
      <input id="screen" class="screen" value="0" readonly />
      <div class="subline">
        <span>‚å´ Backspace ‚Ä¢ C Esc</span>
        <span id="miniInfo">‚Äî</span>
      </div>

      <div class="grid" id="grid">
        <button class="key danger" data-action="clear" type="button">C</button>
        <button class="key danger" data-action="back" type="button">‚å´</button>
        <button class="key op" data-value="%" type="button">%</button>
        <button class="key op" data-value="/" type="button">√∑</button>

        <button class="key" data-value="7" type="button">7</button>
        <button class="key" data-value="8" type="button">8</button>
        <button class="key" data-value="9" type="button">9</button>
        <button class="key op" data-value="*" type="button">√ó</button>

        <button class="key" data-value="4" type="button">4</button>
        <button class="key" data-value="5" type="button">5</button>
        <button class="key" data-value="6" type="button">6</button>
        <button class="key op" data-value="-" type="button">‚àí</button>

        <button class="key" data-value="1" type="button">1</button>
        <button class="key" data-value="2" type="button">2</button>
        <button class="key" data-value="3" type="button">3</button>
        <button class="key op" data-value="+" type="button">+</button>

        <button class="key wide" data-value="0" type="button">0</button>
        <button class="key" data-value="." type="button">.</button>
        <button class="key good eq" data-action="equals" type="button">=</button>
      </div>

      <div class="hint">Para birimi se√ßimi (‚Ç∫/$) g√∂sterim i√ßindir.</div>
    </div>

    <!-- KDV -->
    <div class="panel" id="panel-kdv">
      <div class="row">
        <select id="kdvRate" class="field" style="min-width:160px; flex:0 0 auto">
          <option value="1">KDV 1%</option>
          <option value="8">KDV 8%</option>
          <option value="10">KDV 10%</option>
          <option value="18" selected>KDV 18%</option>
          <option value="20">KDV 20%</option>
        </select>
        <button class="btn" id="netToBrut" type="button">Net ‚Üí Br√ºt</button>
        <button class="btn" id="brutToNet" type="button">Br√ºt ‚Üí Net</button>
      </div>
      <div class="out" id="kdvOut">Ekrandaki sayƒ± √ºzerinden hesaplar.</div>
    </div>

    <!-- Y√úZDE -->
    <div class="panel" id="panel-pct">
      <div class="row">
        <input id="baseA" class="field" type="text" inputmode="decimal" placeholder="A (taban) √∂rn: 1.250,50" />
        <input id="percB" class="field" type="text" inputmode="decimal" placeholder="B (%) √∂rn: 18" />
      </div>
      <div class="row">
        <button class="btn" id="aOfB" type="button">A'nƒ±n %B'si</button>
        <button class="btn" id="aPlusB" type="button">A + %B</button>
        <button class="btn" id="aMinusB" type="button">A - %B</button>
      </div>
      <div class="out" id="percOut">A ve B girip hesapla.</div>
      <div class="hint">TR (1.234,56) ve US (1,234.56) formatƒ± otomatik anla≈üƒ±lƒ±r.</div>
    </div>

    <!-- KAR/ZARAR -->
    <div class="panel" id="panel-profit">
      <div class="row">
        <input id="cost" class="field" type="text" inputmode="decimal" placeholder="Maliyet" />
        <input id="sell" class="field" type="text" inputmode="decimal" placeholder="Satƒ±≈ü" />
      </div>
      <div class="row">
        <button class="btn" id="profitCalc" type="button">Hesapla</button>
        <button class="btn" id="swap" type="button">Yer deƒüi≈ütir</button>
      </div>
      <div class="out" id="profitOut">Maliyet ve satƒ±≈ü girip ‚ÄúHesapla‚Äù.</div>
      <div class="hint">K√¢r = Satƒ±≈ü ‚àí Maliyet ‚Ä¢ K√¢r% (maliyet bazlƒ±) ‚Ä¢ Marj% (satƒ±≈ü bazlƒ±)</div>
    </div>

    <!-- KUR (Manuel) -->
    <div class="panel" id="panel-fx">
      <div class="row">
        <input id="fxRate" class="field" type="text" inputmode="decimal" placeholder="Kur (√∂rn: 35,50)  ‚Äî  1 USD = ? TRY" />
        <button class="btn" id="fxUseUSDTRY" type="button">USD/TRY</button>
        <button class="btn" id="fxUseEURTRY" type="button">EUR/TRY</button>
      </div>

      <div class="row" style="margin-top:10px">
        <input id="fxAmount" class="field" type="text" inputmode="decimal" placeholder="Tutar (√∂rn 1000)" />
        <select id="fxFrom" class="field" style="min-width:140px; flex:0 0 auto">
          <option value="USD" selected>USD</option>
          <option value="TRY">TRY</option>
          <option value="EUR">EUR</option>
        </select>
        <select id="fxTo" class="field" style="min-width:140px; flex:0 0 auto">
          <option value="TRY" selected>TRY</option>
          <option value="USD">USD</option>
          <option value="EUR">EUR</option>
        </select>
        <button class="btn" id="fxConvert" type="button">√áevir</button>
      </div>

      <div class="out" id="fxOut">Kur girip √ßevir yapabilirsin.</div>

      <div class="hint">
        TCMB otomatik √ßekme √∂zelliƒüini sonra ekleyeceƒüiz (GitHub Pages tarafƒ±nda CORS sebebiyle doƒürudan √ßekim sorunlu olabiliyor).
      </div>
    </div>

    <!-- ƒ∞HRACAT -->
    <div class="panel" id="panel-export">
      <div class="row">
        <select id="incoterm" class="field" style="min-width:160px; flex:0 0 auto">
          <option value="FOB" selected>FOB</option>
          <option value="CFR">CFR</option>
          <option value="CIF">CIF</option>
          <option value="EXW">EXW</option>
        </select>

        <select id="expCur" class="field" style="min-width:140px; flex:0 0 auto">
          <option value="USD" selected>USD</option>
          <option value="EUR">EUR</option>
          <option value="GBP">GBP</option>
          <option value="TRY">TRY</option>
        </select>
      </div>

      <div class="row" style="margin-top:10px">
        <input id="goodsValue" class="field" type="text" inputmode="decimal" placeholder="Mal bedeli (√∂rn 25000)" />
        <input id="freight" class="field" type="text" inputmode="decimal" placeholder="Navlun (√∂rn 1200)" />
        <input id="insurance" class="field" type="text" inputmode="decimal" placeholder="Sigorta (√∂rn 150)" />
      </div>

      <div class="row" style="margin-top:10px">
        <input id="inland" class="field" type="text" inputmode="decimal" placeholder="ƒ∞√ß nakliye (√∂rn 300)" />
        <input id="portFees" class="field" type="text" inputmode="decimal" placeholder="Liman masrafƒ± (√∂rn 200)" />
        <input id="commissionPct" class="field" type="text" inputmode="decimal" placeholder="Komisyon % (√∂rn 2.5)" />
      </div>

      <div class="row" style="margin-top:10px">
        <input id="qty" class="field" type="text" inputmode="decimal" placeholder="Miktar (√∂rn 3000)" />
        <input id="unitPrice" class="field" type="text" inputmode="decimal" placeholder="Birim fiyat (opsiyonel)" />
        <button class="btn" id="expCalc" type="button">Maliyet Hesapla</button>
      </div>

      <div class="row" style="margin-top:10px">
        <select id="profitBase" class="field" style="min-width:180px; flex:0 0 auto">
          <option value="FOB" selected>Hedef satƒ±≈ü baz: FOB</option>
          <option value="CIF">Hedef satƒ±≈ü baz: CIF</option>
        </select>
        <input id="targetProfitPct" class="field" type="text" inputmode="decimal" placeholder="Hedef k√¢r % (√∂rn 12)" />
        <button class="btn" id="priceWithProfit" type="button">Satƒ±≈ü Fiyatƒ±</button>
      </div>

      <div class="out" id="expOut">
        FOB/CFR/CIF + masraflar + hedef satƒ±≈ü burada g√∂r√ºnecek.
      </div>

      <div class="hint">
        Basit mantƒ±k: CFR = FOB + Navlun ‚Ä¢ CIF = CFR + Sigorta. Hedef satƒ±≈ü = (se√ßilen baz maliyet) √ó (1 + k√¢r%).
      </div>
    </div>

    <!-- YORUMLAR -->
    <div class="panel" id="panel-comments">
      <div class="row">
        <input id="cName" class="field" type="text" placeholder="ƒ∞sim (opsiyonel)" />
      </div>

      <div class="row" style="margin-top:10px">
        <input id="cText" class="field" type="text" maxlength="500" placeholder="Yorum yaz (max 500 karakter)..." />
        <button class="btn" id="cSend" type="button">G√∂nder</button>
      </div>

      <div class="out" id="cStatus">Baƒülanƒ±yor‚Ä¶</div>
      <div class="out" id="cList" style="margin-top:10px">Yorumlar y√ºkleniyor‚Ä¶</div>

      <div class="hint">Yorumlar Firebase √ºzerinde tutulur ve herkes tarafƒ±ndan g√∂r√ºlebilir.</div>
    </div>

  </div>
</div>

<script>
  // ---------- Formatting helpers ----------
  const currencySel = document.getElementById("currency");

  function sym(cur){ return cur==="TRY" ? "‚Ç∫" : (cur==="USD" ? "$" : "¬§"); }
  function loc(cur){ return cur==="TRY" ? "tr-TR" : "en-US"; }
  function fmtMoney(n, cur){
    const formatted = new Intl.NumberFormat(loc(cur), {minimumFractionDigits:0, maximumFractionDigits:2}).format(n);
    return `${sym(cur)} ${formatted}`;
  }

  // Accept "1.234,56" or "1,234.56" or plain
  function parseLooseNumber(s){
    if (s == null) return null;
    s = String(s).trim();
    if (!s) return null;

    s = s.replace(/[‚Ç∫$‚Ç¨¬£]/g, "").replace(/\s+/g, "");

    const hasComma = s.includes(",");
    const hasDot = s.includes(".");

    if (hasComma && hasDot){
      const lastComma = s.lastIndexOf(",");
      const lastDot = s.lastIndexOf(".");
      const decimalIsComma = lastComma > lastDot;
      if (decimalIsComma){
        s = s.replace(/\./g, "").replace(",", ".");
      } else {
        s = s.replace(/,/g, "");
      }
    } else if (hasComma && !hasDot){
      s = s.replace(/\./g, "").replace(",", ".");
    } else {
      s = s.replace(/,/g, "");
    }

    const n = Number(s);
    return Number.isFinite(n) ? n : null;
  }

  function normalize(n){
    if (!Number.isFinite(n)) return null;
    return Number(n.toFixed(12));
  }

  // ---------- Tabs ----------
  const tabsWrap = document.getElementById("tabs");
  const tabButtons = Array.from(document.querySelectorAll(".tab"));
  const panels = {
    calc: document.getElementById("panel-calc"),
    kdv: document.getElementById("panel-kdv"),
    pct: document.getElementById("panel-pct"),
    profit: document.getElementById("panel-profit"),
    fx: document.getElementById("panel-fx"),
    export: document.getElementById("panel-export"),
    comments: document.getElementById("panel-comments"),
  };

  function setActiveTab(key){
    tabButtons.forEach(b => b.classList.toggle("active", b.dataset.tab === key));
    Object.entries(panels).forEach(([k, el]) => el.classList.toggle("active", k === key));
  }

  tabsWrap.addEventListener("pointerdown", (e) => {
    const t = e.target.closest(".tab");
    if (!t) return;
    e.preventDefault();
    setActiveTab(t.dataset.tab);
  });

  // ---------- Calculator ----------
  const screen = document.getElementById("screen");
  const grid = document.getElementById("grid");
  const miniInfo = document.getElementById("miniInfo");
  let expr = "0";

  function setExpr(v){ expr = v; render(); }
  function isPlainNumberExpression(s){ return /^[0-9.]+$/.test(s); }
  function safeEval(expression){
    if (!/^[0-9+\-*/%.]+$/.test(expression)) throw new Error("bad");
    return Function('"use strict"; return (' + expression + ')')();
  }

  function render(){
    if (expr === "Hata"){ screen.value = "Hata"; return; }
    if (isPlainNumberExpression(expr)){
      const n = Number(expr);
      screen.value = Number.isFinite(n) ? fmtMoney(n, currencySel.value) : "Hata";
      return;
    }
    screen.value = expr;
  }

  function append(ch){
    const cur = expr;
    if (cur === "Hata"){ setExpr("0"); return append(ch); }
    if (cur === "0" && /[0-9]/.test(ch)) return setExpr(ch);

    if (/[+\-*/%]$/.test(cur) && /[+\-*/%]/.test(ch)) return setExpr(cur.slice(0,-1) + ch);

    if (ch === "."){
      const part = cur.split(/[+\-*/%]/).pop();
      if (part.includes(".")) return;
    }
    setExpr(cur + ch);
  }

  function backspace(){
    if (expr === "Hata") return setExpr("0");
    if (expr.length <= 1) return setExpr("0");
    setExpr(expr.slice(0,-1));
  }

  function clearAll(){ setExpr("0"); miniInfo.textContent = "‚Äî"; }

  function equals(){
    try{
      const res = normalize(safeEval(expr));
      if (res === null) return setExpr("Hata");
      setExpr(String(res));
      miniInfo.textContent = "Sonu√ß hesaplandƒ±";
    } catch {
      setExpr("Hata");
      miniInfo.textContent = "Ge√ßersiz ifade";
    }
  }

  function handleKey(btn){
    const action = btn.dataset.action;
    const val = btn.dataset.value;
    if (action === "clear") return clearAll();
    if (action === "back") return backspace();
    if (action === "equals") return equals();
    if (val) return append(val);
  }

  grid.addEventListener("pointerdown", (e) => {
    const btn = e.target.closest("button");
    if (!btn) return;
    e.preventDefault();
    handleKey(btn);
  });

  window.addEventListener("keydown", (e) => {
    const k = e.key;
    if (/[0-9]/.test(k)) return append(k);
    if (["+", "-", "*", "/", "%", "."].includes(k)) return append(k);
    if (k === "Enter" || k === "=") return equals();
    if (k === "Backspace") return backspace();
    if (k === "Escape") return clearAll();
  });

  function screenNumber(){
    if (isPlainNumberExpression(expr)){
      const n = Number(expr);
      return Number.isFinite(n) ? n : null;
    }
    try{
      const res = normalize(safeEval(expr));
      return res;
    } catch {
      return null;
    }
  }

  currencySel.addEventListener("change", () => render());

  // ---------- KDV ----------
  const kdvRate = document.getElementById("kdvRate");
  const kdvOut = document.getElementById("kdvOut");
  const netToBrutBtn = document.getElementById("netToBrut");
  const brutToNetBtn = document.getElementById("brutToNet");

  function rate(){ return Number(kdvRate.value)/100; }

  netToBrutBtn.addEventListener("pointerdown", (e) => {
    e.preventDefault();
    const net = screenNumber();
    if (net === null) return (kdvOut.textContent = "Ekrandaki deƒüer sayƒ± deƒüil.");
    const brut = normalize(net * (1 + rate()));
    const kdvTutar = normalize(brut - net);
    setExpr(String(brut));
    miniInfo.textContent = `KDV ${kdvRate.value}% uygulandƒ±`;
    kdvOut.innerHTML = `<b>Net:</b> ${fmtMoney(net, currencySel.value)} ‚Üí <b>Br√ºt:</b> ${fmtMoney(brut, currencySel.value)} ‚Ä¢ <b>KDV:</b> ${fmtMoney(kdvTutar, currencySel.value)}`;
  });

  brutToNetBtn.addEventListener("pointerdown", (e) => {
    e.preventDefault();
    const brut = screenNumber();
    if (brut === null) return (kdvOut.textContent = "Ekrandaki deƒüer sayƒ± deƒüil.");
    const net = normalize(brut / (1 + rate()));
    const kdvTutar = normalize(brut - net);
    setExpr(String(net));
    miniInfo.textContent = `KDV ${kdvRate.value}% ayrƒ±≈ütƒ±rƒ±ldƒ±`;
    kdvOut.innerHTML = `<b>Br√ºt:</b> ${fmtMoney(brut, currencySel.value)} ‚Üí <b>Net:</b> ${fmtMoney(net, currencySel.value)} ‚Ä¢ <b>KDV:</b> ${fmtMoney(kdvTutar, currencySel.value)}`;
  });

  // ---------- Percent ----------
  const baseA = document.getElementById("baseA");
  const percB = document.getElementById("percB");
  const percOut = document.getElementById("percOut");
  const aOfB = document.getElementById("aOfB");
  const aPlusB = document.getElementById("aPlusB");
  const aMinusB = document.getElementById("aMinusB");

  function pctCalc(kind){
    const A = parseLooseNumber(baseA.value);
    const B = parseLooseNumber(percB.value);
    if (A === null || B === null){
      percOut.textContent = "A ve B'yi sayƒ± olarak gir.";
      return;
    }
    const p = B/100;
    let res;
    if (kind==="of") res = A*p;
    if (kind==="plus") res = A*(1+p);
    if (kind==="minus") res = A*(1-p);
    res = normalize(res);

    setExpr(String(res));
    miniInfo.textContent = "Y√ºzde hesaplandƒ±";

    const label = kind==="of" ? "A'nƒ±n %B'si" : (kind==="plus" ? "A + %B" : "A - %B");
    percOut.innerHTML = `<b>${label}:</b> A=${fmtMoney(A, currencySel.value)}, B=${B}% ‚Üí <b>${fmtMoney(res, currencySel.value)}</b>`;
  }

  aOfB.addEventListener("pointerdown", (e)=>{e.preventDefault(); pctCalc("of");});
  aPlusB.addEventListener("pointerdown", (e)=>{e.preventDefault(); pctCalc("plus");});
  aMinusB.addEventListener("pointerdown", (e)=>{e.preventDefault(); pctCalc("minus");});

  // ---------- Profit/Loss ----------
  const cost = document.getElementById("cost");
  const sell = document.getElementById("sell");
  const profitOut = document.getElementById("profitOut");
  const profitCalc = document.getElementById("profitCalc");
  const swap = document.getElementById("swap");

  function profit(){
    const c = parseLooseNumber(cost.value);
    const s = parseLooseNumber(sell.value);
    if (c === null || s === null){
      profitOut.textContent = "Maliyet ve Satƒ±≈ü deƒüerlerini sayƒ± olarak gir.";
      return;
    }
    const p = normalize(s - c);
    const profitPct = c===0 ? null : normalize((p/c)*100);
    const marginPct = s===0 ? null : normalize((p/s)*100);

    setExpr(String(p));
    miniInfo.textContent = "Kar/Zarar hesaplandƒ±";
    profitOut.innerHTML = `<b>K√¢r:</b> ${fmtMoney(p, currencySel.value)} ‚Ä¢ <b>K√¢r% (maliyet):</b> ${profitPct===null?"‚Äî":profitPct+"%"} ‚Ä¢ <b>Marj% (satƒ±≈ü):</b> ${marginPct===null?"‚Äî":marginPct+"%"}`;
  }

  profitCalc.addEventListener("pointerdown", (e)=>{e.preventDefault(); profit();});
  swap.addEventListener("pointerdown", (e)=>{
    e.preventDefault();
    const tmp = cost.value; cost.value = sell.value; sell.value = tmp;
    profit();
  });

  // ---------- FX (Manual) ----------
  const fxRate = document.getElementById("fxRate");
  const fxUseUSDTRY = document.getElementById("fxUseUSDTRY");
  const fxUseEURTRY = document.getElementById("fxUseEURTRY");
  const fxAmount = document.getElementById("fxAmount");
  const fxFrom = document.getElementById("fxFrom");
  const fxTo = document.getElementById("fxTo");
  const fxConvert = document.getElementById("fxConvert");
  const fxOut = document.getElementById("fxOut");

  fxUseUSDTRY.addEventListener("pointerdown", (e)=>{ e.preventDefault(); fxFrom.value="USD"; fxTo.value="TRY"; });
  fxUseEURTRY.addEventListener("pointerdown", (e)=>{ e.preventDefault(); fxFrom.value="EUR"; fxTo.value="TRY"; });

  fxConvert.addEventListener("pointerdown", (e)=>{
    e.preventDefault();
    const r = parseLooseNumber(fxRate.value);
    const amt = parseLooseNumber(fxAmount.value);
    if (r === null || r <= 0) return (fxOut.textContent = "Kur ge√ßersiz. √ñrn: 35,50");
    if (amt === null) return (fxOut.textContent = "Tutar ge√ßersiz.");

    const from = fxFrom.value;
    const to = fxTo.value;

    // Basit: girilen kur "1 USD/EUR = r TRY" gibi d√º≈ü√ºn√ºl√ºr.
    // USD<->TRY veya EUR<->TRY √ßalƒ±≈üƒ±r. USD<->EUR i√ßin TRY k√∂pr√º gibi.
    const base = from; // USD veya EUR veya TRY
    let result = null;

    function toTRY(x){
      if (base === "TRY") return x;
      return x * r; // 1 base = r TRY
    }
    function fromTRY(x){
      if (to === "TRY") return x;
      return x / r;
    }

    if ((from === "USD" || from === "EUR") && to === "TRY"){
      result = amt * r;
    } else if (from === "TRY" && (to === "USD" || to === "EUR")){
      result = amt / r;
    } else if ((from === "USD" || from === "EUR") && (to === "USD" || to === "EUR")){
      // USD->EUR: (USD->TRY) then (TRY->EUR) using same r (yakla≈üƒ±k)
      // Bu ekran basit deneme i√ßin: aynƒ± r kullanƒ±ldƒ±ƒüƒ± i√ßin sadece yakla≈üƒ±k olur.
      const inTRY = amt * r;
      result = inTRY / r;
    } else {
      result = amt; // fallback
    }

    fxOut.innerHTML = `<b>${amt}</b> ${from} ‚âà <b>${normalize(result).toFixed(4)}</b> ${to}`;
    setExpr(String(normalize(result)));
    miniInfo.textContent = "Kur √ßevirildi";
  });

  // ---------- Export calculator ----------
  const incoterm = document.getElementById("incoterm");
  const expCur = document.getElementById("expCur");
  const goodsValue = document.getElementById("goodsValue");
  const freight = document.getElementById("freight");
  const insurance = document.getElementById("insurance");
  const inland = document.getElementById("inland");
  const portFees = document.getElementById("portFees");
  const commissionPct = document.getElementById("commissionPct");
  const qty = document.getElementById("qty");
  const unitPrice = document.getElementById("unitPrice");
  const expCalc = document.getElementById("expCalc");
  const expOut = document.getElementById("expOut");
  const profitBase = document.getElementById("profitBase");
  const targetProfitPct = document.getElementById("targetProfitPct");
  const priceWithProfit = document.getElementById("priceWithProfit");

  function computeFOB_CFR_CIF(goods, navlun, sig, term){
    let FOB = goods, CFR = goods + navlun, CIF = goods + navlun + sig;

    if (term === "FOB"){
      FOB = goods;
      CFR = FOB + navlun;
      CIF = CFR + sig;
    } else if (term === "CFR"){
      CFR = goods;
      FOB = CFR - navlun;
      CIF = CFR + sig;
    } else if (term === "CIF"){
      CIF = goods;
      CFR = CIF - sig;
      FOB = CFR - navlun;
    } else if (term === "EXW"){
      FOB = goods;
      CFR = goods + navlun;
      CIF = CFR + sig;
    }

    return { FOB: normalize(FOB), CFR: normalize(CFR), CIF: normalize(CIF) };
  }

  function readExportInputs(){
    const cur = expCur.value;
    const term = incoterm.value;

    let goods = parseLooseNumber(goodsValue.value);
    const navlun = parseLooseNumber(freight.value) || 0;
    const sig = parseLooseNumber(insurance.value) || 0;

    const inl = parseLooseNumber(inland.value) || 0;
    const port = parseLooseNumber(portFees.value) || 0;
    const commPct = parseLooseNumber(commissionPct.value) || 0;

    const q = parseLooseNumber(qty.value);
    const up = parseLooseNumber(unitPrice.value);

    if (q != null && up != null){
      goods = q * up;
    }

    return {cur, term, goods, navlun, sig, inl, port, commPct, q};
  }

  function fmtPlain(n, cur){
    return `${normalize(n).toFixed(4)} ${cur}`;
  }

  expCalc.addEventListener("pointerdown", (e)=>{
    e.preventDefault();

    const {cur, term, goods, navlun, sig, inl, port, commPct, q} = readExportInputs();
    if (goods == null){
      expOut.textContent = "Mal bedeli (veya miktar + birim fiyat) gir.";
      return;
    }

    const totals = computeFOB_CFR_CIF(goods, navlun, sig, term);

    // Komisyonu mal bedeli √ºzerinden alƒ±yoruz (deneme s√ºr√ºm√º, net ve stabil)
    const commissionAmount = normalize(goods * (commPct/100));

    const FOB_cost = normalize(totals.FOB + inl + port + commissionAmount);
    const CIF_cost = normalize(totals.CIF + inl + port + commissionAmount);

    let unit = "";
    if (q != null && q !== 0){
      unit = `<br><b>Birim maliyet:</b> FOB ${normalize(FOB_cost/q).toFixed(4)} ${cur} ‚Ä¢ CIF ${normalize(CIF_cost/q).toFixed(4)} ${cur}`;
    }

    expOut.innerHTML =
      `<b>${cur}</b> bazƒ±nda (girdi incoterm: <b>${term}</b>)<br>
       <b>FOB:</b> ${fmtPlain(totals.FOB,cur)}<br>
       <b>CFR:</b> ${fmtPlain(totals.CFR,cur)}<br>
       <b>CIF:</b> ${fmtPlain(totals.CIF,cur)}<br>
       <hr style="border:none;border-top:1px solid rgba(255,255,255,.08);margin:10px 0">
       <b>Masraflar:</b> ƒ∞√ß nakliye ${fmtPlain(inl,cur)} ‚Ä¢ Liman ${fmtPlain(port,cur)} ‚Ä¢ Komisyon ${fmtPlain(commissionAmount,cur)}<br>
       <b>Toplam Maliyet (FOB baz):</b> ${fmtPlain(FOB_cost,cur)}<br>
       <b>Toplam Maliyet (CIF baz):</b> ${fmtPlain(CIF_cost,cur)}
       ${unit}`;

    setExpr(String(CIF_cost));
    miniInfo.textContent = "ƒ∞hracat maliyeti hesaplandƒ±";
  });

  priceWithProfit.addEventListener("pointerdown", (e)=>{
    e.preventDefault();

    const {cur, term, goods, navlun, sig, inl, port, commPct, q} = readExportInputs();
    const tp = parseLooseNumber(targetProfitPct.value);

    if (goods == null){
      expOut.textContent = "Mal bedeli (veya miktar + birim fiyat) gir.";
      return;
    }
    if (tp == null){
      expOut.textContent = "Hedef k√¢r % gir (√∂rn 12).";
      return;
    }

    const totals = computeFOB_CFR_CIF(goods, navlun, sig, term);
    const commissionAmount = normalize(goods * (commPct/100));
    const FOB_cost = normalize(totals.FOB + inl + port + commissionAmount);
    const CIF_cost = normalize(totals.CIF + inl + port + commissionAmount);

    const base = profitBase.value; // FOB / CIF
    const baseCost = (base === "FOB") ? FOB_cost : CIF_cost;

    const sale = normalize(baseCost * (1 + tp/100));

    let unit = "";
    if (q != null && q !== 0){
      unit = ` ‚Ä¢ <b>Birim satƒ±≈ü:</b> ${normalize(sale/q).toFixed(4)} ${cur}`;
    }

    expOut.innerHTML =
      `<b>Hedef satƒ±≈ü fiyatƒ±</b> (${base} baz, k√¢r%: ${tp})<br>
       <b>Toplam maliyet:</b> ${fmtPlain(baseCost,cur)}<br>
       <b>Satƒ±≈ü fiyatƒ±:</b> ${fmtPlain(sale,cur)}${unit}`;

    setExpr(String(sale));
    miniInfo.textContent = "Hedef satƒ±≈ü hesaplandƒ±";
  });

  // Register service worker (PWA)
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("./sw.js");
  }

  render();
</script>

<!-- ================= YORUMLAR + FIREBASE (TEK BLOK) ================= -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    getFirestore, collection, addDoc,
    serverTimestamp, query, orderBy, limit, onSnapshot
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyClINZcNN-ULMNa0IXb1Oh8dRUyM6XLYwU",
    authDomain: "jml-hesap.firebaseapp.com",
    projectId: "jml-hesap",
    storageBucket: "jml-hesap.firebasestorage.app",
    messagingSenderId: "329153387130",
    appId: "1:329153387130:web:c3f9224cabb57488a9b9c3"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const cName = document.getElementById("cName");
  const cText = document.getElementById("cText");
  const cSend = document.getElementById("cSend");
  const cStatus = document.getElementById("cStatus");
  const cList = document.getElementById("cList");

  function esc(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  async function boot(){
    try{
      await signInAnonymously(auth);
      cStatus.textContent = "Baƒülandƒ±. Yorum yazabilirsin.";
    }catch(e){
      cStatus.textContent = "Baƒülanamadƒ± (Auth kapalƒ± olabilir).";
      console.error(e);
      return;
    }

    const q = query(collection(db, "comments"), orderBy("createdAt", "desc"), limit(50));
    onSnapshot(q, (snap) => {
      if (snap.empty){
        cList.textContent = "Hen√ºz yorum yok.";
        return;
      }

      const items = [];
      snap.forEach((doc) => {
        const d = doc.data() || {};
        const name = (d.name && String(d.name).trim()) ? String(d.name).trim() : "Anonim";
        const text = String(d.text || "");
        items.push(`
          <div class="listItem">
            <b>${esc(name)}</b>
            <div style="margin-top:6px;opacity:.86;white-space:pre-wrap">${esc(text)}</div>
          </div>
        `);
      });
      cList.innerHTML = items.join("");
    });

    let lastSend = 0;
    cSend.addEventListener("pointerdown", async (e) => {
      e.preventDefault();
      const now = Date.now();
      if (now - lastSend < 2500){
        cStatus.textContent = "Biraz yava≈ü üôÇ";
        return;
      }
      lastSend = now;

      const text = (cText.value || "").trim();
      const name = (cName.value || "").trim().slice(0, 40);

      if (!text) return (cStatus.textContent = "Yorum bo≈ü olamaz.");
      if (text.length > 500) return (cStatus.textContent = "Max 500 karakter.");

      try{
        await addDoc(collection(db, "comments"), {
          name,
          text,
          createdAt: serverTimestamp()
        });
        cText.value = "";
        cStatus.textContent = "G√∂nderildi ‚úÖ";
      }catch(err){
        cStatus.textContent = "G√∂nderilemedi (Rules/Firestore).";
        console.error(err);
      }
    });
  }

  boot();
</script>
<!-- ================================================================ -->

</body>
</html>
